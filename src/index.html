<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css" type="text/css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Germania+One&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap"
    rel="stylesheet">
  <title>Kette Suchen</title>
</head>

<body>
  <main id="main">
    <section class="container">
      <div class="header-wrapper">
        <h1 id="header">Kette Suchen</h1>
      </div>
      <section class="section-chain-length">
        <label for="chain-length-input" class="chain-length-label">Set chain length</label>
        <div class="chain-length-container">
          <input id="chain-length-input" type="number" min="2" max="100" value="2" class="input-chain-length">
          <button id="set-chain-length-button">Set chain</button>
        </div>
      </section>
      <section class="chain-input-wrapper">
        <label for="chain-input" class="chain-input-label">Add chain text</label>
        <input id="chain-input" type="text" maxlength="1000" placeholder="Suche nach einem Wort">
        <button id="add-button">Add</button>
      </section>
      <section class="chain-preview-wrapper"></section>
      <div class="play-wrapper">
        <button id="play-button">Let's play!</button>
      </div>
      <section id="game"></section>
    </section>

  </main>

  <script>
    var wordPositions;
    var splitSymbol = " ";
    var chainLength = 2;
    var closeTileDelay = 2000;
    var wordChains = new Map();
    var indexToWord = new Map();
    var selectedWords = [];
    var chainInput = document.querySelector("#chain-input");
    var chainPreview = document.querySelector(".chain-preview-wrapper");
    var addButton = document.querySelector("#add-button");
    var playButton = document.querySelector("#play-button");
    var game = document.querySelector("#game");
    var setLengthButton = document.querySelector("#set-chain-length-button");
    var chainLengthInput = document.querySelector("#chain-length-input");

    function getWordPositions(cl, wc) {
      const elementsCount = wc.size;
      const iterator = wc.values();
      const wordPositions = new Array(elementsCount * cl);
      let chain = iterator.next();

      for (let i = 0; i < elementsCount; i++) {
        let words = chain.value.split(splitSymbol);
        for (let j = 0; j < cl; j++) {
          let position = Math.floor(Math.random() * elementsCount * cl);
          if (wordPositions[position]) {
            while (wordPositions[position] !== undefined) {
              if (position >= wordPositions.length - 1) {
                position = 0;
                continue;
              }
              position += 1;
            }
            wordPositions[position] = words[j];
          } else {
            wordPositions[position] = words[j];
          }
        }
        chain = iterator.next();
      }
      return wordPositions;
    }

    function onTileClick(sw, tile) {
      const tileId = tile.getAttribute("tile-id");
      const word = indexToWord.get(tileId);
      if (sw.length !== chainLength && sw.length < chainLength) {
        addWordForCalculation(word, tileId, sw);
        tile.classList.add("word-container--opened");
        tile.innerText = "";
      } else {
        closeTiles(selectedWords);
        addWordForCalculation(word, tileId, sw);
        tile.classList.add("word-container--opened");
        tile.innerText = "";
      }

      if (sw.length === chainLength) {
        const hash = calculateWords(sw);
        if (wordChains.has(hash)) {
          for (let w of sw) {
            const tile = document.querySelector(`[tile-id="${w.tileId}"]`);
            tile.remove();
          }
          wordChains.delete(hash);
          sw.length = 0;
        }
      }
    }

    function createTiles(wp) {
      for (let i = 0; i < wordPositions.length; i++) {
        const div = document.createElement("div");
        const tileId = i + 1;
        indexToWord.set(String(tileId), wp[i]);
        div.classList.add("word-container");
        div.setAttribute("tile-id", tileId);
        div.innerText = tileId;

        div.addEventListener("animationend", function (ev) {
          if (ev.animationName === "open-word-container") {
            openTile(String(tileId), this);
            this.classList.remove("word-container--opened");
          }
          if (ev.animationName === "close-word-container") {
            this.innerHTML = tileId;
            this.classList.remove("word-container--closed");
          }
        });

        div.addEventListener("click", function () {
          onTileClick(selectedWords, this);
        });
        game.appendChild(div);
      }
    }

    function addWordForCalculation(w, tid, sw) {
      const wordData = {
        word: w,
        tileId: tid
      };
      sw.push(wordData);
    }

    function calculateWords(sw) {
      let hash = 0;
      for (w of sw) {
        hash += w.word.split("").reduce((acc, curr) => {
          const code = curr.charCodeAt(0);
          return acc + code;
        }, 0);
      }
      return hash;
    }

    function openTile(tid, tile) {
      const word = indexToWord.get(tid);
      tile.innerHTML = word;
    }

    function closeTiles(sw) {
      sw.forEach(wd => {
        const tile = document.querySelector(`[tile-id="${wd.tileId}"]`);
        tile.classList.add("word-container--closed");
        tile.innerHTML = '';
      });
      sw.length = 0;
    }

    function addChain() {
      const input = chainInput.value;
      if (chainInput.value) {
        const words = chainInput.value.trim().split(splitSymbol);
        if (words.length === chainLength) {
          let hash = 0;
          for (w of words) {
            hash += w.split("").reduce((acc, curr) => {
              const code = curr.charCodeAt(0);
              return acc + code;
            }, 0);
          }
          if (!wordChains.has(hash)) {
            wordChains.set(hash, chainInput.value.trim());
            const span = document.createElement("span");
            span.classList.add("word-preview");
            const text = document.createTextNode(chainInput.value);
            span.appendChild(text);
            chainPreview.appendChild(span);
            chainInput.value = "";
          }
        }
      }
    }

    function addDisabledAttr(elements) {
      elements.forEach((el) => el.disabled = true);
    }

    setLengthButton.addEventListener("click", function (event) {
      const newChainLength = parseInt(chainLengthInput.value, 10);
      if (newChainLength) {
        chainLength = newChainLength;
      }
    });

    addButton.addEventListener("click", function (event) {
      addChain();
    });

    playButton.addEventListener("click", function (event) {
      wordPositions = getWordPositions(chainLength, wordChains);
      createTiles(wordPositions);
      chainPreview.innerHTML = "";
      addDisabledAttr([this, addButton, setLengthButton]);
    });

    chainInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter") addChain();
    })

  </script>
</body>

</html>
